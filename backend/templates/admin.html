<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuickieBot Admin Panel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
  <div class="container">
    <h1>QuickieBot Admin Panel</h1>
    <p class="welcome">Welcome, {{ username }}!</p>

    <!-- Logout -->
    <form id="logoutForm" class="center-form">
      <button type="submit" class="logout-btn">Logout</button>
    </form>

    <!-- Upload Section -->
    <div class="upload-section">
      <h2>Upload New Resource</h2>
      <form id="uploadForm" enctype="multipart/form-data" class="center-form">
        <input type="file" name="file" id="fileInput" required>
        <input type="file" name="thumbnail" id="thumbInput" accept="image/*">
        <input type="text" name="description" id="descInput" placeholder="Description (optional)">
        <button type="submit" class="upload-btn">Upload Resource</button>
      </form>
    </div>

    <!-- Resource List -->
    <div class="resources-section">
      <h2>Uploaded Resources</h2>
      <div id="resourceGrid" class="resource-grid">
        {% for res in resources %}
        <div class="resource-card" data-id="{{ res.id }}">
          {% if res.thumbnail %}
            <img src="{{ url_for('uploaded_file', filename=res.thumbnail) }}" alt="Thumbnail" class="resource-thumb">
          {% else %}
            <div class="resource-thumb placeholder">No Thumbnail</div>
          {% endif %}

          <div class="resource-info">
            <h3>{{ res.filename }}</h3>
            <p class="desc">{{ res.description or 'No description provided.' }}</p>

            <div class="edit-fields">
              <input type="text" class="editDescInput" value="{{ res.description }}">
              <input type="file" class="editFileInput">
              <input type="file" class="editThumbInput" accept="image/*">
            </div>
          </div>

          <div class="btn-group">
            <a href="{{ url_for('uploaded_file', filename=res.filename) }}" target="_blank" class="view-link">View / Download</a>
            <button class="edit-resource">Edit</button>
            <button class="save-resource">Save</button>
            <button class="cancel-edit">Cancel</button>
            <button class="delete-resource">Delete</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Logout
      document.getElementById("logoutForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await fetch("/admin/logout", { method: "POST" });
        window.location.href = "/admin/login";
      });

      // Upload
      document.getElementById("uploadForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append("file", document.getElementById("fileInput").files[0]);
        const thumb = document.getElementById("thumbInput").files[0];
        if (thumb) formData.append("thumbnail", thumb);
        formData.append("description", document.getElementById("descInput").value);
        await fetch("/api/resources", { method: "POST", body: formData });
        location.reload();
      });

      // Edit, Save, Cancel, Delete Logic
      document.querySelectorAll(".edit-resource").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const card = e.target.closest(".resource-card");
          card.classList.add("editing");
        });
      });

      document.querySelectorAll(".cancel-edit").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const card = e.target.closest(".resource-card");
          card.classList.remove("editing");
        });
      });

      document.querySelectorAll(".save-resource").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const card = e.target.closest(".resource-card");
          const id = card.dataset.id;
          const formData = new FormData();
          formData.append("description", card.querySelector(".editDescInput").value);
          if (card.querySelector(".editFileInput").files.length > 0)
            formData.append("file", card.querySelector(".editFileInput").files[0]);
          if (card.querySelector(".editThumbInput").files.length > 0)
            formData.append("thumbnail", card.querySelector(".editThumbInput").files[0]);
          await fetch(`/api/resources/${id}`, { method: "PUT", body: formData });
          location.reload();
        });
      });

      document.querySelectorAll(".delete-resource").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const card = e.target.closest(".resource-card");
          const id = card.dataset.id;
          await fetch(`/api/resources/${id}`, { method: "DELETE" });
          location.reload();
        });
      });
    });
  </script>
</body>
</html>
